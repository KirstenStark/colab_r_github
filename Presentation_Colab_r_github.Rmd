---
title: "Collaborating on Reproducible Code Using R and GitHub"
author: "Alexander Enge & Kirsten Stark"
date: "13/01/2021"
output:
  ioslides_presentation:
    widescreen: true
    smaller: true
    transition: "faster"
    logo: "figures/hu_logo.png"
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE)
```
<style>
div.footnotes {
  bottom: .01;
  width: 80%;
  font-size: 0.55em;
  margin-left: 120px;
}
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script><script>
$(document).ready(function() {
  $('slide:not(.backdrop):not(.title-slide)').append('<div class=\"footnotes\">');
  $('footnote').each(function(index) {
    var text  = $(this).html();
    var fnNum = (index+1).toString();
    $(this).html(fnNum.sup());
    var footnote   = fnNum + '. ' + text + '<br/>';
    var oldContent = $(this).parents('slide').children('div.footnotes').html();
    var newContent = oldContent + footnote;
    $(this).parents('slide').children('div.footnotes').html(newContent);
  });});
</script>

```{css styling}
/* Make the HU logo bigger */
slides > slide:not(.nobackground):before {
  width: 100px;
  height: 100px;
  background-size: 100px 100px;
}

/* Make the background plain white */
slides > slide {
  background: linear-gradient(white, white);
}
```

## Schedule

1. **Working in different contexts:** RStudio Projects
2. **Dynamic document generation:** RMarkdown
3. **Version control:** Git + GitHub
4. **Environment management**: renv
5. **Containerization**: Docker
6. **Where should I start?**
7. **Start collaborating**

## 0. Kudos

- Peikert, A., & Brandmaier, A. M. (2020). A Reproducible Data Analysis Workflow with R Markdown, Git, Make, and Docker. https://doi.org/10.31234/osf.io/8xzqy

```{r out.width='75%', fig.align='center'}
include_graphics("figures/peikert_preprint.png")
```

## 0. Collaborating with yourself and others
```{r, fig.align='center'}
include_graphics("figures/ResearchManagement.png")
```

## 1. Working in different contexts: RStudio Projects - What & Why?
```{r out.extra='style="float:right; padding:10px"', out.width = '10%'}
include_graphics("figures/RStudioProject.png")
```

- **What it does**:
  + Allows to work in multiple different contexts (projects), e.g. one for each experiment
  + Each project is own working directory, workspace, history, and source documents
  + Each project is associated with a folder on your computer (= working directory)
- **Why it helps**:
  + Have a separate, shareable working environment for each experiment
  + Keep all the files associated with a project together — data, scripts, results, figures
  + Work on multiple projects at once, each associated with its packages (and package versions), loaded data, etc. 
  + Use only relative paths
  + Necessary basis for version control

## 1. Working in different contexts: RStudio Projects – How?

- In RStudio: File > New Project > ...

```{r out.extra='style="float:left; padding:10px"', out.width = '40%'}
include_graphics("figures/NewProject.png")
```
```{r out.extra='style="float:right; padding:10px"', out.width = '50%'}
include_graphics("figures/CreateProject.png")
```

## 1. Working in different contexts: RStudio Projects – Version 1: Create new project

```{r out.extra='style="float:left; padding:10px"', out.width = '35%'}
include_graphics("figures/CreateProject.png")
```
```{r out.extra='style="float:right; padding:10px"', out.width = '55%'}
include_graphics("figures/CreateNewProject.png")
```

## 1. Working in different contexts: RStudio Projects – Version 1: Create new project

```{r out.extra='style="float:left; padding:10px"', out.width = '35%'}
include_graphics("figures/CreateNewProject.png")
```
```{r out.extra='style="float:right; padding:10px"', out.width = '55%'}
include_graphics("figures/CreateNewProjectType.png")
```

## 1. Working in different contexts: RStudio Projects – Version 1: Create new project

```{r out.extra='style="float:left"', out.width = '100%'}
include_graphics("figures/RProjectSleepstudy.png")
```

## 1. Working in different contexts: RStudio Projects – Version 2: Create from existing directory

```{r out.extra='style="float:left; padding:10px"', out.width = '35%'}
include_graphics("figures/CreateProject.png")
```
```{r out.extra='style="float:right; padding:10px"', out.width = '55%'}
include_graphics("figures/CreateProjectFromExistingDirectory.png")
```

## 1. Working in different contexts: RStudio Projects – Version 3: Create from version control (Git)

```{r out.extra='style="float:left; padding:10px"', out.width = '35%'}
include_graphics("figures/CreateProject.png")
```
```{r out.extra='style="float:right; padding:10px"', out.width = '55%'}
include_graphics("figures/CreateProjectFromVersionControl.png")
```

## 1. Working in different contexts: RStudio Projects – Version 3: Create from version control (Git)

```{r out.extra='style="float:left; padding:10px"', out.width = '35%'}
include_graphics("figures/CreateProjectFromVersionControl.png")
```
```{r out.extra='style="float:right; padding:10px"', out.width = '55%'}
include_graphics("figures/CloneGitRepository.png")
```

## 1. Working in different contexts: RStudio Projects – Open and manage projects

```{r out.extra='style="float:left; padding:10px"', out.width = '25%'}
include_graphics("figures/OpenProject.png")
```
```{r out.extra='style="float:left; padding:10px"', out.width = '70%'}
include_graphics("figures/ChooseProject.png")
```

## 1. Working in different contexts: RStudio Projects – Open and manage projects
```{r, fig.align='center'}
include_graphics("figures/ProjectOptions.png")
```


## 1. Working in different contexts: RStudio Projects – Tricks and troubleshooting

- **Relative paths:** path separator characters vary across systems & anchor points differ depending on contexts
  + **Use the `here`-package (Müller, 2020) to define relative paths within the project: `read.csv(here::here("data", "file_I_want.csv"))`**

## 2. Dynamic document generation: RMarkdown - What & Why?
```{r out.extra='style="float:right; padding:10px"', out.width = '10%'}
include_graphics("figures/rmarkdown.png")
```

- **What it does:**
  + Creates dynamic documents with embedded chunks of code (R, python, Julia, stan, ...), computed results , written text etc. (= LaTeX) 
  + Markdown-files can be exported to documents (docx, rtf), presentations, pdfs, websites (html), ... <footnote content="packages"> e.g using the `knitr` (Xie, 2015, 2020) and `tinytex` (Xie, 2015, 2020; for pdfs)</footnote>
  + R code is dynamically rendered, and can be given in separate chunks ('''{r}   ''') or inline (' r  … ')
- **Why it helps:**
  + Simple language ($\neq$ LaTeX)
  + Integrates directly with statistical software (R Studio)
  + Saves code and output in one file
  + Reduces copy&paste errors: reported results consistent with actual results

## 2. Dynamic document generation: RMarkdown - How?

- Installation: `install.packages("rmarkdown")`

## 2. Dynamic document generation: RMarkdown - How?

- Installation: `install.packages("rmarkdown")`
- Open a markdown file: File > New File > R Markdown


```{r out.extra='style="float:left"', out.width = '35%'}
include_graphics("figures/RMarkdown_newfile.png")
```


## 2. Dynamic document generation: RMarkdown - How?

- Installation: `install.packages("rmarkdown")`
- Open a markdown file: File > New File > R Markdown

```{r out.extra='style="float:left; padding:10px"', out.width = '35%'}
include_graphics("figures/RMarkdown_newfile.png")
```
```{r out.extra='style="float:right; padding:10px"', out.width = '55%'}
include_graphics("figures/RMarkdown_fileformat.png")
```

## {data-background="figures/RMarkdown_file_plain.png"}
## {data-background="figures/RMarkdown_file_header.png"}
## {data-background="figures/RMarkdown_file_text.png"}
## {data-background="figures/RMarkdown_file_Rcode.png"}
## {data-background="figures/RMarkdown_file_knit.png"}
## {data-background="figures/RMarkdownFile.png"}
## {data-background="figures/RMarkdown_output.png"}
## {data-background="figures/RMarkdown_output.png"}
```{r fig.align = "right", out.width = '35%'}
include_graphics("figures/RMarkdown_output_files.png")
```


## 2. Dynamic document generation: RMarkdown - Tricks & troubleshooting

- You don't have RStudio installed: **install Pandoc (http://pandoc.org)** before installing *markdown* ()
- Lengthy R code chunks: **Install `knitr`-package (Xie, 2014, 2015, 2020) to customize chunks and knitting process** 
  + `{r cache=TRUE,message=FALSE,warning=FALSE,results="hide", error = TRUE}`
  + or use `opts_chunk$set()`-function
- Knit to pdf: You need a **LaTeX-installation**
  + **`TinyTeX`** (Xie, 2010) is a light-weight, cross-platform distribution (`install.packages("tinytex"); tinytex::install_tinytex())`)
  - Separate code chunks by a blank line


## 3. Version control: Git + GitHub - What & Why?

```{r, fig.align='center', out.width = '65%'}
include_graphics("figures/jesus.jpg")
```

## 3. Version control: Git + GitHub - What & Why?

- What it does:
  + Tracks changes to files (data and code) over time: Sequence of "snapshots" (**commits**) wit unique identifiers (hash code) and describition (commit message)
  + Allows to "go back in time": Recall older versions or to revert the entire project
  + Changes between commits can be compared
  + Organized in **repositories**: Collection of all snapshots
  + **GitHub**: Popular server for sharing materials (*privately or publicly*) and collaborating via git (also: GitLab and others)
  
## 3. Version control: Git + GitHub - What & Why?

```{r out.extra='style="float:right; padding:10px"', out.width = '35%'}
include_graphics("figures/VersionControl.png")
```

- Why it helps:
  + Keep things organized and track changes
  + Clean up code
  + Language agnostic
  + (Remote) backup
  + Work together (even simultaneously and parallely: branches, merges, pull requests)
  + Web interface to track issues
  + Easily connected e.g. to osf.io

## 3. Version control: Git + GitHub – How?

- ...

## 3. Version control: Git + GitHub - Troubleshooting

- **Github:** No long-term guarantee for availability of service (is commercial) 
  - **Mirror snapshots on hu servers/osf/zenodo/FigShare/...**

## 4. Environment management: renv

```{r out.width='70%', fig.align='right'}
# # This was used to create the plot. To run this code, please install pkggraph and ggplot2.
# library(pkggraph)
# library(dplyr)
# library(ggplot2)
# get_all_dependencies("lmerTest", level = 10, relation = c("Depends", "Imports"), strict = TRUE) %>%
#   make_neighborhood_graph() %>%
#   plot(background = "white") +
#   theme(panel.border = element_rect(color = "white")) +
#   ggsave("figures/lmerTest_depends.png", width = 20, height = 14, units = "cm", dpi = 600)
include_graphics("figures/lmerTest_depends.png")
```

## 4. renv – What & Why?

- What it does:
  + Creates a project-specific library of packages in the project folder
  + Overwrites `install.packages()` to install packages there
  + Keeps track of package versions in the `renv.lock` file
- Why it helps:
  + Keeps package versions untouched by other projects
  + Allows you to revert to the previous state when an update has broken your analysis
  + Makes it easier to share package versions with your collaborators (e.g., via GitHub)

```{r fig.align='right'}
include_graphics("figures/renv.png")
```

## 4. renv – How?

1. Install the renv package: `install.packages(renv)`
2. Initialize your project library: `renv::init()`
3. Install and update your packages as usual: `install.packages("pkgname")`
3. Save the current state of the project library: `renv::snapshot()`
4. Revert to a previous state if an update caused problems: `renv::restore()`

You can skip step #2 if you select "Use renv with this project" during project creation.

```{r fig.align='right'}
include_graphics("figures/renv.png")
```

## 4. renv – Troubleshooting

- If necessary

## 5. Containerization: Docker

```{r fig.align='right'}
include_graphics("figures/containers.jpg")
```

## 5. Docker – What & Why?

- What it does:
  + ...
  + ...
- Why it helps:
  + ...
  + ...

## 5. Docker – How?

- ...

## 5. Docker – Troubleshooting

- If necessary

## 6. Where should I start?

- Suggested order of steps, minimal and maximal version

## 7. Start colaborating

- ...

